-- Aimbot Script Mejorado para Roblox
local Players = game:GetService("Players")
local UserInputService = game:GetService("UserInputService")
local RunService = game:GetService("RunService")
local player = Players.LocalPlayer
local mouse = player:GetMouse()
local camera = workspace.CurrentCamera

-- Variables Aimbot
local aimbotEnabled = false
local currentTarget = nil
local connection = nil
local espConnection = nil
local highlights = {}
local smoothness = 0.4 -- Ajusta para más rápido o más natural
local maxAimAngle = math.rad(30) -- Solo targets dentro de 30° del crosshair

-- GUI Setup
local ScreenGui = Instance.new("ScreenGui")
ScreenGui.Parent = player:WaitForChild("PlayerGui")
ScreenGui.ZIndexBehavior = Enum.ZIndexBehavior.Sibling
ScreenGui.ResetOnSpawn = false

local Aimbot = Instance.new("Frame")
Aimbot.Name = "Aimbot"
Aimbot.Parent = ScreenGui
Aimbot.BackgroundColor3 = Color3.fromRGB(255, 0, 0)
Aimbot.BackgroundTransparency = 0.4
Aimbot.BorderSizePixel = 0
Aimbot.Position = UDim2.new(0.05,0,0.3,0)
Aimbot.Size = UDim2.new(0,192,0,61)
Aimbot.Visible = false
Aimbot.Active = true
Aimbot.Draggable = true

local UICorner = Instance.new("UICorner")
UICorner.Parent = Aimbot

local TextLabel = Instance.new("TextLabel")
TextLabel.Parent = Aimbot
TextLabel.BackgroundTransparency = 1
TextLabel.Position = UDim2.new(0.3,0,-0.4,0)
TextLabel.Size = UDim2.new(0,100,0,25)
TextLabel.Font = Enum.Font.FredokaOne
TextLabel.Text = "Jonh Universal"
TextLabel.TextColor3 = Color3.fromRGB(0,0,0)
TextLabel.TextSize = 14

local AimbotButton = Instance.new("TextButton")
AimbotButton.Name = "AimbotButton"
AimbotButton.Parent = Aimbot
AimbotButton.BackgroundColor3 = Color3.fromRGB(186,174,174)
AimbotButton.BackgroundTransparency = 0.3
AimbotButton.BorderSizePixel = 0
AimbotButton.Position = UDim2.new(0.35,0,0.44,0)
AimbotButton.Size = UDim2.new(0,89,0,25)
AimbotButton.Font = Enum.Font.SourceSansBold
AimbotButton.Text = "AIMBOT HEAD"
AimbotButton.TextColor3 = Color3.fromRGB(0,0,0)
AimbotButton.TextSize = 14

local UICorner_2 = Instance.new("UICorner")
UICorner_2.Parent = AimbotButton

local TextLabel_2 = Instance.new("TextLabel")
TextLabel_2.Parent = Aimbot
TextLabel_2.BackgroundTransparency = 1
TextLabel_2.Position = UDim2.new(0.22,0,0,0)
TextLabel_2.Size = UDim2.new(0,108,0,27)
TextLabel_2.Font = Enum.Font.FredokaOne
TextLabel_2.Text = "Aimbot Menu"
TextLabel_2.TextColor3 = Color3.fromRGB(0,0,0)
TextLabel_2.TextSize = 14

local AbrirButton = Instance.new("ImageButton")
AbrirButton.Name = "AbrirButton"
AbrirButton.Parent = ScreenGui
AbrirButton.BackgroundTransparency = 1
AbrirButton.BorderSizePixel = 0
AbrirButton.Position = UDim2.new(0,10,0.5,-20)
AbrirButton.Size = UDim2.new(0,40,0,40)
AbrirButton.Image = "rbxassetid://3570695787"
AbrirButton.ImageColor3 = Color3.fromRGB(255,0,0)

-- Funciones Aimbot
local function isEnemy(otherPlayer)
    if player.Team == nil or otherPlayer.Team == nil then return true end
    return player.Team ~= otherPlayer.Team
end

local function hasLineOfSight(targetHead)
    local character = player.Character
    if not character then return false end
    if not targetHead or not targetHead.Parent then return false end

    local origin = camera.CFrame.Position
    local direction = (targetHead.Position - origin)
    local distance = direction.Magnitude

    local raycastParams = RaycastParams.new()
    raycastParams.FilterDescendantsInstances = {character}
    raycastParams.FilterType = Enum.RaycastFilterType.Blacklist
    raycastParams.IgnoreWater = true

    local raycastResult = workspace:Raycast(origin, direction.Unit*distance, raycastParams)

    if not raycastResult then return true end
    local hitPart = raycastResult.Instance
    if hitPart:IsDescendantOf(targetHead.Parent) then return true end
    return false
end

local function findNearestToCrosshair()
    local nearestPlayer = nil
    local smallestAngle = maxAimAngle
    local cameraDirection = camera.CFrame.LookVector

    for _, otherPlayer in ipairs(Players:GetPlayers()) do
        if otherPlayer ~= player and otherPlayer.Character and isEnemy(otherPlayer) then
            local character = otherPlayer.Character
            local humanoid = character:FindFirstChild("Humanoid")
            local head = character:FindFirstChild("Head")
            if humanoid and humanoid.Health > 0 and head and hasLineOfSight(head) then
                local dirToTarget = (head.Position - camera.CFrame.Position).Unit
                local angle = math.acos(cameraDirection:Dot(dirToTarget))
                if angle < smallestAngle then
                    smallestAngle = angle
                    nearestPlayer = character
                end
            end
        end
    end
    return nearestPlayer
end

local function updateAimbot()
    if not aimbotEnabled then return end
    currentTarget = findNearestToCrosshair()
    if not currentTarget then return end

    local targetHead = currentTarget:FindFirstChild("Head")
    if not targetHead then return end

    -- Movimiento suave hacia el target
    local dirToTarget = (targetHead.Position - camera.CFrame.Position).Unit
    local angleDifference = math.acos(camera.CFrame.LookVector:Dot(dirToTarget))
    local lerpFactor = math.clamp(smoothness*(1/(angleDifference+0.01)),0,1)
    camera.CFrame = camera.CFrame:Lerp(CFrame.new(camera.CFrame.Position, targetHead.Position), lerpFactor)
end

-- Funciones ESP
local function getRainbowColor()
    local hue = (tick()%5)/5
    return Color3.fromHSV(hue,1,1)
end

local function createHighlight(character)
    if not character or not character.Parent then return nil end
    local highlight = Instance.new("Highlight")
    highlight.Name = "ESPHighlight"
    highlight.Adornee = character
    highlight.FillTransparency = 0.8
    highlight.FillColor = Color3.fromRGB(255,0,0)
    highlight.OutlineTransparency = 0
    highlight.OutlineColor = Color3.fromRGB(255,0,0)
    highlight.DepthMode = Enum.HighlightDepthMode.AlwaysOnTop
    highlight.Enabled = true
    highlight.Parent = character
    return highlight
end

local function updateESP()
    local rainbowColor = getRainbowColor()
    for _, otherPlayer in ipairs(Players:GetPlayers()) do
        if otherPlayer ~= player and isEnemy(otherPlayer) then
            local character = otherPlayer.Character
            if character and character.Parent then
                local humanoid = character:FindFirstChild("Humanoid")
                local head = character:FindFirstChild("Head")
                if humanoid and humanoid.Health>0 and head then
                    local highlight = character:FindFirstChild("ESPHighlight")
                    if not highlight then
                        highlight = createHighlight(character)
                        highlights[otherPlayer.UserId] = highlight
                    end
                    if highlight then
                        highlight.FillColor = rainbowColor
                        highlight.OutlineColor = rainbowColor
                    end
                else
                    local highlight = character:FindFirstChild("ESPHighlight")
                    if highlight then highlight:Destroy() end
                    highlights[otherPlayer.UserId] = nil
                end
            end
        end
    end
end

local function removeAllHighlights()
    for _, otherPlayer in ipairs(Players:GetPlayers()) do
        if otherPlayer.Character then
            local highlight = otherPlayer.Character:FindFirstChild("ESPHighlight")
            if highlight then highlight:Destroy() end
        end
    end
    highlights = {}
end

-- Toggle Aimbot
local function toggleAimbot()
    aimbotEnabled = not aimbotEnabled
    if aimbotEnabled then
        AimbotButton.Text = "AIMBOT ON"
        AimbotButton.TextColor3 = Color3.fromRGB(0,255,0)
        connection = RunService.Heartbeat:Connect(updateAimbot)
        espConnection = RunService.Heartbeat:Connect(updateESP)
    else
        AimbotButton.Text = "AIMBOT HEAD"
        AimbotButton.TextColor3 = Color3.fromRGB(0,0,0)
        if connection then connection:Disconnect() connection=nil end
        if espConnection then espConnection:Disconnect() espConnection=nil end
        removeAllHighlights()
    end
end

-- Toggle GUI
local function toggleMenu()
    Aimbot.Visible = not Aimbot.Visible
end

-- Conectar eventos
AimbotButton.MouseButton1Click:Connect(toggleAimbot)
AbrirButton.MouseButton1Click:Connect(toggleMenu)
